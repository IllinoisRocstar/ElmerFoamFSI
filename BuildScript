#!/bin/bash

isFirst=false
noTest=false
buildFoam=true

if [ "$1" = "First" ] || [ "$1" = "FIRST" ] || [ "$1" = "first" ] || [ "$2" = "First" ] || [ "$2" = "FIRST" ] || [ "$2" = "first" ] || [ "$3" = "First" ] || [ "$3" = "FIRST" ] || [ "$3" = "first" ]
then
  isFirst=true
fi
if [ "$1" = "notest" ] || [ "$1" = "NoTest" ] || [ "$1" = "NOTEST" ] || [ "$2" = "notest" ] || [ "$2" = "NoTest" ] || [ "$2" = "NOTEST" ] || [ "$3" = "notest" ] || [ "$3" = "NoTest" ] || [ "$3" = "NOTEST" ] 
then
  noTest=true
fi
if [ "$1" = "nofoam" ] || [ "$1" = "NoFoam" ] || [ "$1" = "NOFOAM" ] || [ "$2" = "nofoam" ] || [ "$2" = "NoFoam" ] || [ "$2" = "NOFOAM" ] || [ "$3" = "nofoam" ] || [ "$3" = "NoFoam" ] || [ "$3" = "NOFOAM" ]
then
  buildFoam=false
fi

# Set our current directory, which should be the top
# level source for ElmerFoamFSI
topSourceDir=`pwd`
installDir="$topSourceDir/support_install"

echo "Build log for ElmerFoam Tool Chain" 2>&1 | tee Build.dat
 
if $isFirst
then
  echo "Patching OpenFoam & Elmer for the first build"  2>&1 | tee -a Build.dat
#  ./BuildTools/PatchScript $topSourceDir 2>&1 | tee -a Build.dat
  if [ ${PIPESTATUS[0]} -ne 0 ]
  then
    echo "Error in executing PatchScript" 2>&1 | tee -a Build.dat
    exit 1
  fi
fi

echo "Sourcing BashSourceScript" 2>&1 | tee -a Build.dat 

# Source the SourceScript to ensure the proper build environment
source BuildTools/BashSourceScript $topSourceDir 2>&1 | tee -a Build.dat
if [ ${PIPESTATUS[0]} -ne 0 ]
then
  echo "Error: Unable to source BashSourceScript" 2>&1 | tee -a Build.dat
  exit 1
fi

# Build OpenFoam
if $buildFoam
then
  if $isFirst
  then 
    ./BuildTools/BuildOpenFoam $topSourceDir first 2>&1 | tee -a Build.dat
    if [ ${PIPESTATUS[0]} -ne 0 ]
    then
      echo "Error in building OpenFoam" 2>&1 | tee -a Build.dat
      exit 1
    fi
  else 
    ./BuildTools/BuildOpenFoam $topSourceDir 2>&1 | tee -a Build.dat
    if [ ${PIPESTATUS[0]} -ne 0 ]
    then
      echo "Error in building OpenFoam" 2>&1 | tee -a Build.dat
      exit 1
    fi
  fi
fi

# Build IMPACT, which will also build IRAD 
./BuildTools/BuildIMPACT $topSourceDir 2>&1 | tee -a Build.dat
if [ ${PIPESTATUS[0]} -ne 0 ]
then
  echo "Error in building IMPACT & IRAD" 2>&1 | tee -a Build.dat
  exit 1
fi

# Build elmer and the elmer module
if $isFirst
then
  ./BuildTools/BuildElmerModule $topSourceDir first 2>&1 | tee -a Build.dat
  if [ ${PIPESTATUS[0]} -ne 0 ]
  then
    echo "Error in building Elmer & Elmer Module" 2>&1 | tee -a Build.dat
    exit 1
  fi
else
  ./BuildTools/BuildElmerModule $topSourceDir 2>&1 | tee -a Build.dat
  if [ ${PIPESTATUS[0]} -ne 0 ]
  then
    echo "Error in building Elmer & Elmer Module" 2>&1 | tee -a Build.dat
    exit 1
  fi
fi

# Build openfoam module
./BuildTools/BuildOpenFoamModule $topSourceDir 2>&1 | tee -a Build.dat
if [ ${PIPESTATUS[0]} -ne 0 ]
then
  echo "Error in building OpenFoam module" 2>&1 | tee -a Build.dat
  exit 1
fi

# Build the ElmerFoamFSI driver
if $noTest
then
  ./BuildTools/BuildElmerFoamFSIDriver $topSourceDir noTest 2>&1 | tee -a Build.dat
  if [ ${PIPESTATUS[0]} -ne 0 ]
  then
    echo "Error in building ElmerFoamFSI Driver" 2>&1 | tee -a Build.dat
    exit 1
  fi
else
  ./BuildTools/BuildElmerFoamFSIDriver $topSourceDir 2>&1 | tee -a Build.dat
  if [ ${PIPESTATUS[0]} -ne 0 ]
  then
    echo "Error in building ElmerFoamFSI Driver & running tests" 2>&1 | tee -a Build.dat
    exit 1
  fi
fi
